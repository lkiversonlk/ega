var DB;"undefined"!=typeof require&&(DB=require("../../db"));function Configuration(){"undefined"==typeof window?this.server=!0:this.server=!1,this.conf={}}Configuration.prototype.CATEGORY={GRID_CONF_CATEGORY:"grid"},Configuration.prototype.Params={GRID_PIC_URL_BASE:"/grid_avatars/"},Configuration.prototype.getConf=function(o,n,t){return this.conf.hasOwnProperty(o)?this.conf[o].hasOwnProperty(n)?t(null,this.conf[o][n]):t():(this.conf[o]={},t())},Configuration.prototype.loadConf=function(o,n,t){var e=this;e.getConf(o,n,i=>{if(i)return t(null,i);e._reload(o,n,(i,r)=>(i||(e.conf[o][n]=r),t(i,r)))})},Configuration.prototype.forceReloadConf=function(o,n,t){var e=this;e._reload(o,n,(i,r)=>i?t(i):(e.cacheConf(o,n,r),t(null,r)))},Configuration.prototype._reload=function(o,n,t){if(this.server){var e=DB.get();if(!e)return t("db not connected");e.collection(o).findOne({_id:n},t)}else{var i=(new Date).getTime();$.get("/conf/"+o+"?id="+n+"&t="+i,function(o,n,e){return t(null,o)}).fail(function(){return console.log("fail to reloa conf "+arguments.toString()),t(FAIL_LOAD_CONF)})}},Configuration.prototype.cacheConf=function(o,n,t){this.conf.hasOwnProperty(o)||(this.conf[o]={}),this.conf[o][n]=t},Configuration.prototype.saveConf=function(o,n,t,e){var i=this;if(i.server){var r=DB.get();t._id=n;r.collection(o).findOneAndUpdate({_id:n},t,{upsert:!0},(r,f)=>r?e(r):(console.log("cache conf "+JSON.stringify(t)),i.cacheConf(o,n,t),e(null,t)))}else $.post("/conf/"+o+"?id="+n,t,(t,r)=>(i.cacheConf(o,n,r),e(null,r))).fail(()=>e(FAIL_SAVE_CONF))};var loadAllCalled=!1;Configuration.prototype.loadAllConf=function(o,n){var t=this;if(t.server){DB.get().collection(o).find().toArray((e,i)=>{if(e)return n(e);var r={};return i.forEach(o=>{r[o._id]=o}),t.conf[o]=r,n(null,r)})}else $.get("/conf/"+o,function(e,i,r){return t.conf[o]=e,n(null,e)}).fail(o=>n(FAIL_LOAD_CONF))},"undefined"!=typeof module&&(module.exports=Configuration);