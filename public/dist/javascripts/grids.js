function Grid(r,i){if(this.size=r,this.lat_per_grid=180/r,this.lng_per_grid=360/r,"undefined"==typeof window)this.server=!0;else{if(this.server=!1,void 0===i)throw"confSerivce is null";this.confService=i}this.conf={},this.grid_lines=[],this.grid_avatars={},this.grid_buildings={}}Grid.prototype.degreeToRadians=function(r){return r*(Math.PI/180)},Grid.prototype.radiansToDegree=function(r){return r/(Math.PI/180)},Grid.prototype.fromLatLngToGrid=function(r,i){return x=parseInt((parseFloat(i)+180)/this.lng_per_grid),y=parseInt((parseFloat(r)+90)/this.lat_per_grid),y*this.size+x},Grid.prototype.showGrids=function(r){var i=this;i.grid_lines.forEach(function(i){i.show=r}),Object.keys(i.grid_avatars).forEach(function(e){i.grid_avatars[e].polygon.show=r})},Grid.prototype.drawGrids=function(r){var i=0;for(i=0;i<this.size;i++){for(var e=this.lng_per_grid*i,t=[],s=-89.5;s<=89.5;s++)t.push(Cesium.Cartesian3.fromDegrees(e,s));var o=r.entities.add({polyline:{followSurface:!0,width:.1,material:Cesium.Color.GRAY,positions:t}});this.grid_lines.push(o)}for(i=1;i<this.size;i++){for(s=this.lat_per_grid*(i-this.size/2),t=[],e=-179.5;e<179.5;e++)t.push(Cesium.Cartesian3.fromDegrees(e,s));o=r.entities.add({polyline:{followSurface:!0,width:.1,material:Cesium.Color.GRAY,positions:t}});this.grid_lines.push(o)}},Grid.prototype.drawGridAvatars=function(r,i){var e=this;e.confService.loadAllConf(e.confService.CATEGORY.GRID_CONF_CATEGORY,(t,s)=>{if(t)return i&&i(t);Object.keys(s).forEach(function(i){s[i];e.gridAvatar(i,(t,s)=>{t||s&&e.drawGridAvatar(i,s,r,r=>{})})})})},Grid.prototype.fromGridIndexToDegrees=function(r){var i=Math.floor(r/this.size),e=r-i*this.size,t=[],s=this.fromOffsetToDegrees(e,i);t.push(s.lng,s.lat);for(var o=this.fromOffsetToDegrees(e+1,i),a=1;s.lng+a<o.lng;a+=1)t.push(s.lng+a,s.lat);t.push(o.lng,o.lat);var n=this.fromOffsetToDegrees(e+1,i+1);for(a=1;o.lat+a<n.lat;a+=1)t.push(o.lng,o.lat+a);t.push(n.lng,n.lat);var d=this.fromOffsetToDegrees(e,i+1);for(a=1;n.lng-a>d.lng;a+=1)t.push(n.lng-a,n.lat);t.push(d.lng,d.lat);for(a=1;d.lat-a>s.lat;a+=1)t.push(d.lng,d.lat-a);return t},Grid.prototype.fromOffsetToDegrees=function(r,i){return{lng:r*this.lng_per_grid-180,lat:i*this.lat_per_grid-90}},Grid.prototype.fromGridIndexToXY=function(r){if(r<0||r>=this.size*this.size)throw"invalid grid "+r;r=Math.floor(r);var i=Math.floor(r/this.size);return{x:r-i*this.size,y:i}},Grid.prototype.gridCenterInDegree=function(r){var i=this.fromGridIndexToXY(r),e=this.fromOffsetToDegrees(i.x,i.y),t=this.fromOffsetToDegrees(i.x+1,i.y),s=this.fromOffsetToDegrees(i.x,i.y+1);return{lng:(e.lng+t.lng)/2,lat:(e.lat+s.lat)/2}},Grid.prototype.destory=function(){},Grid.prototype.gridAvatar=function(r,i){var e=this;e.confService.getConf(e.confService.CATEGORY.GRID_CONF_CATEGORY,r,(r,t)=>r?i(r):t&&t.avatar?i(null,e.confService.Params.GRID_PIC_URL_BASE+t.avatar):i())},Grid.prototype.drawGridAvatar=function(r,i,e){if(this.grid_avatars.hasOwnProperty(r))this.grid_avatars[r].polygon.material=i;else{var t=this.fromGridIndexToDegrees(r),s=e.entities.add({name:"grid_picture",polygon:{height:1e4,material:i,outline:!1,hierarchy:Cesium.Cartesian3.fromDegreesArray(t)}});this.grid_avatars[r]=s}},Grid.prototype.updateGridAvatar=function(r,i){var e=this;e.gridAvatar(r,(t,s)=>{t||(s?e.drawGridAvatar(r,s,i):e.removeGridAvatar(r,i))})},Grid.prototype.removeGridAvatar=function(r,i){this.grid_avatars.hasOwnProperty(r)&&(i.entities.remove(this.grid_avatars[r]),delete this.grid_avatars[r])},Grid.prototype.gridBuilding=function(r,i,e,t,s){this.grid_buildings.hasOwnProperty(r)&&(s.scene.primitives.remove(this.grid_buildings[r]),delete this.grid_buildings[r]);var o=this.gridCenterInDegree(r);position=Cesium.Cartesian3.fromDegrees(o.lng,o.lat,t);var a=new Cesium.HeadingPitchRoll,n=Cesium.Transforms.localFrameToFixedFrameGenerator("north","west"),d=s.scene.primitives.add(Cesium.Model.fromGltf({url:i,modelMatrix:Cesium.Transforms.headingPitchRollToFixedFrame(position,a,Cesium.Ellipsoid.WGS84,n),minimumPixelPriceSize:128,shadows:Cesium.ShadowMode.DISABLED,scale:e}));this.grid_buildings[r]=d},"undefined"!=typeof module&&(module.exports=Grid);